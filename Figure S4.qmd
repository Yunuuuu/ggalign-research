# Genomic density and Rainfall plot

Setup output directory
```{r}
#| code-fold: true
if (!dir.exists("output")) dir.create("output")
```

```{r}
load(system.file(package = "circlize", "extdata", "DMR.RData"))
bed_data <- dplyr::bind_rows(hyper = DMR_hyper, hypo = DMR_hypo, .id = "DMR") |>
    dplyr::relocate(DMR, .after = dplyr::last_col())
```

```{r}
#| code-fold: true
library(ggalign)
```

```{r}
FigureS4 <- circle_genomic(
    "hg19",
    radial = coord_radial(inner.radius = 0.2, rotate.angle = TRUE),
    direction = "inward",
    theme = theme(
        plot.margin = margin(t = 10, b = 10, l = 2, unit = "mm")
    )
) -
    # Remove radial axes for a cleaner circular look
    scheme_theme(
        axis.text.r = element_blank(),
        axis.ticks.r = element_blank()
    ) +

    # Cytoband (Ideogram) Layer ------------------
    plot_ideogram() +
    scale_x_continuous(
        breaks = scales::breaks_pretty(2),
        labels = scales::label_bytes()
    ) +
    guides(
        r = "none", r.sec = "axis",
        theta = guide_axis_theta(angle = 0)
    ) +
    theme(axis.text.theta = element_text(size = 6)) +

    # add rainfall plot -----------------------
    ggalign(bed_data) +
    geom_point(
        aes(middle, log10(dist), color = DMR),
        data = function(d) {
            d <- dplyr::bind_rows(!!!lapply(
                split(d, ~DMR), function(dd) genomic_dist(dd)
            ))
            d$middle <- (d$start + d$end) / 2
            d
        }
    ) +
    scale_color_brewer(
        palette = "Dark2",
        guide = guide_legend(
            position = "inside",
            theme = theme(
                legend.position.inside = c(0.5, 0.5),
                legend.key = element_rect(color = NA),
                legend.title = element_text(face = "bold")
            )
        )
    ) +

    # add density plot -----------------------
    ggalign(DMR_hyper, size = 0.5) +
    geom_density(
        aes(middle, density, color = after_scale(fill)),
        fill = RColorBrewer::brewer.pal(3, "Dark2")[1L],
        stat = "identity",
        data = function(d) {
            d <- genomic_density(d)
            d$middle <- (d$start + d$end) / 2
            d
        }
    ) +
    ggalign(DMR_hypo, size = 0.5) +
    geom_density(
        aes(middle, density, color = after_scale(fill)),
        fill = RColorBrewer::brewer.pal(3, "Dark2")[2L],
        stat = "identity",
        data = function(d) {
            d <- genomic_density(d)
            d$middle <- (d$start + d$end) / 2
            d
        }
    ) &
    theme(panel.background = element_rect(color = "black", fill = NA))
ggsave("output/FigureS4.pdf",
    plot = FigureS4, width = 9, height = 8,
    family = "Helvetica"
)
```
